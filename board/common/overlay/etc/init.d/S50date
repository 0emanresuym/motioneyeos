#!/bin/bash

# Date executable points to /bin/busybox\ date explicitly in the cases that date binary gets overwritten
DATE_PROG=/bin/busybox\ date

SYS_CONF="/etc/date.conf"
BOOT_CONF="/boot/date.conf"
CONF="/data/etc/date.conf"

SYS_NTP_CONF="/etc/ntp.conf"
BOOT_NTP_CONF="/boot/ntp.conf"
NTP_CONF="/data/etc/ntp.conf"


test -n "$os_version" || source /etc/init.d/base

prepare_conf $CONF $SYS_CONF $BOOT_CONF
prepare_conf $NTP_CONF $SYS_NTP_CONF $BOOT_NTP_CONF

test -f $CONF || exit 0

test "$os_networkless" == "true" && exit 0

date_timeout=10
date_method=http
date_host="google.com"
date_interval="900"

source $CONF


set_current_date_http() {
    date_str=$(curl -v -s -m $date_timeout -X GET http://$date_host 2>&1 | grep Date | sed -e 's/< Date: //')
    test -z "$date_str" && return 1
    $DATE_PROG -u -D "%a, %d %b %Y %H:%M:%S" -s "$date_str" > /dev/null
    return $?
}

set_current_date_ntp() {
    cat $NTP_CONF | grep server | head -n 1 | cut -d ' ' -f 2 | xargs ntpdate -t $date_timeout -s
}

start_http() {
    msg_begin "Setting current date using http"
    set_current_date_http || set_current_date_http
    test $? == 0 && msg_done "$($DATE_PROG)" || msg_fail
    
    msg_begin "Starting http date updater"
    while true; do
        sleep $date_interval
        set_current_date_http
    done &
    msg_done
}

start_ntp() {
    mkdir -p /var/lib/ntp

    cat $NTP_CONF | grep -v iburst > ${NTP_CONF}.tmp

    if [[ -n "$date_ntp_server" ]]; then
        echo "server $date_ntp_server iburst" > $NTP_CONF
    else
        cat $SYS_NTP_CONF | grep iburst > $NTP_CONF
    fi

    cat ${NTP_CONF}.tmp >> $NTP_CONF
    rm ${NTP_CONF}.tmp

    msg_begin "Setting current date using ntp"
    set_current_date_ntp || set_current_date_ntp
    test $? == 0 && msg_done "$($DATE_PROG)" || msg_fail

    msg_begin "Starting ntpd"
    ntpd -g -c $NTP_CONF
    test $? == 0 && msg_done || msg_fail
}

stop_http() {
    msg_begin "Stopping date updater"
    ps | grep S60date | grep -v $$ | grep -v grep | tr -s ' ' | sed -e 's/^\s//' | cut -d ' ' -f 1 | xargs -r kill
    test $? == 0 && msg_done || msg_fail
}

stop_ntp() {
    msg_begin "Stopping ntpd"
    killall ntpd &>/dev/null
    test $? == 0 && msg_done || msg_fail
}

start() {
    if [[ "$date_method" == "http" ]]; then
        start_http
    else
        start_ntp
    fi

    echo "system date is $($DATE_PROG '+%Y-%m-%d %H:%M:%S')" > /dev/kmsg
}

stop() {
    if [[ "$date_method" == "http" ]]; then
        stop_http
    else
        stop_ntp
    fi        
}

case "$1" in
    start)
        start
        ;;

    stop)
        stop
        ;;

    restart)
        stop
        start
        ;;

    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
esac

exit $?

